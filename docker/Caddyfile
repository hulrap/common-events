{
	# Global options
	email {$ACME_EMAIL:admin@example.com}
}

# Main site configuration
{$SITE_DOMAIN:localhost} {
	# Enable compression
	encode gzip zstd

	# Logging
	log {
		output file /var/log/caddy/access.log
		format json
	}

	# Security headers
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options SAMEORIGIN
		X-XSS-Protection "1; mode=block"
		Referrer-Policy strict-origin-when-cross-origin
		-Server
	}

	# PostgREST data endpoints
	handle /rest/v1/* {
		uri strip_prefix /rest/v1
		reverse_proxy rest:3000
	}

	# GoTrue auth endpoints - proxy to auth service
	handle /auth/v1/* {
		uri strip_prefix /auth/v1
		reverse_proxy gotrue:9999
	}

	handle /auth/* {
		uri strip_prefix /auth
		reverse_proxy gotrue:9999
	}

	# MinIO storage - proxy to storage service (public bucket access)
	handle /storage/* {
		uri strip_prefix /storage
		reverse_proxy minio:9000 {
			header_up Host {upstream_hostport}
		}
	}

	# MinIO console (admin only - consider restricting access)
	handle /minio-console/* {
		uri strip_prefix /minio-console
		reverse_proxy minio:9001
	}

	# Supabase Studio Admin Panel (protected by DASHBOARD_USERNAME/PASSWORD in Studio itself)
	handle /studio/* {
		uri strip_prefix /studio
		reverse_proxy studio:3000
	}

	handle /studio {
		redir /studio/ permanent
	}

	# Main application - proxy everything else to Next.js
	handle {
		reverse_proxy app:3000
	}
}

# Health check endpoint (optional, for load balancers)
:8080 {
	respond /health "OK" 200
}

# Supabase Studio Admin Panel (subdomain with HTTP Basic Auth)
eventstudio.commoncause.cc {
	encode gzip zstd
	
	basicauth {
		giveadminaccesstomyownmachine $2a$14$MkAbdeMqI4Ju4YoEOk6o.ufLvpDJ5DwCBMNakxB0tgEqpyq9qU9iq
	}
	
	reverse_proxy studio:3000
}
